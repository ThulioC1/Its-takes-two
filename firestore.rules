rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isMemberOfCouple(coupleId) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.coupleId == coupleId;
    }
    
    match /users/{userId} {
      allow get: if isSignedIn();
      allow update, create: if isSignedIn() && request.auth.uid == userId;
      allow delete, list: if false;
    }
    
    match /couples/{coupleId} {
      allow read, write: if isMemberOfCouple(coupleId);
      
      match /todos/{todoId} {
        allow read, write: if isMemberOfCouple(coupleId);
      }

      match /expenses/{expenseId} {
        allow read, write: if isMemberOfCouple(coupleId);
      }

      match /movies/{movieId} {
        allow read, write: if isMemberOfCouple(coupleId);
      }

      match /games/{gameId} {
        allow read, write: if isMemberOfCouple(coupleId);
      }

      match /dates/{dateId} {
        allow read, write: if isMemberOfCouple(coupleId);
      }

      match /posts/{postId} {
        allow read, write: if isMemberOfCouple(coupleId);

        match /comments/{commentId} {
          allow read, list: if isMemberOfCouple(coupleId);
          allow create: if isMemberOfCouple(coupleId) && request.resource.data.author.uid == request.auth.uid;
          allow delete: if isMemberOfCouple(coupleId) && resource.data.author.uid == request.auth.uid;
          allow update: if false;
        }
      }

      match /memories/{memoryId} {
        allow read, write: if isMemberOfCouple(coupleId);
      }

      match /loveLetters/{loveLetterId} {
        allow read: if isMemberOfCouple(coupleId);
        allow create: if isMemberOfCouple(coupleId) && request.resource.data.senderId == request.auth.uid;
        allow update, delete: if isMemberOfCouple(coupleId) && resource.data.senderId == request.auth.uid;
      }

      match /goals/{goalId} {
        allow read, write: if isMemberOfCouple(coupleId);
      }
      
      match /notifications/{notificationId} {
        // A user can read/list/update notifications intended for them.
        allow read, update: if isMemberOfCouple(coupleId) && resource.data.recipientId == request.auth.uid;
        
        // A user can create a notification for their partner
        allow create: if isMemberOfCouple(coupleId) && request.resource.data.actor.uid == request.auth.uid;

        // Notifications cannot be deleted by clients
        allow delete: if false;
      }
    }
  }
}
